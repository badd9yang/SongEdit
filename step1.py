""" 仅保留五个接口
__all__=["SongEdit",
         "VocalSeparate",
         "SOFA",
         "Proofreading",
         "postprocess"]
"""
from songedit.songedit import *
# from songedit.src.songedit import SongEdit, VocalSeparate, SOFA, Proofreading, postprocess
import os

os.environ["CUDA_VISIBLE_DEVICES"] = "0"

# Total PreProcess
# STEP 1
model = SongEdit(
        separate_model_path= "checkpoints/step1/separate_model.pt",
        asr_model_path= "checkpoints/step1/whisper",
        align_model_path= "checkpoints/step1/align.ckpt",
        spk_dia_model_path= "checkpoints/step1",
        vad_model_path= "checkpoints/step1/vad.onnx",
)

model.process(
        input_folder_path="data/input_data/陈鸿宇-火烧云.flac",
        dataset_path="data/dataset",
        align_out_path="data/align",
        song_and_lyrics_path="data/song_and_lyrics",
)


# STEP 2 用户校对
# Proofreading (插入，以及修改歌词，) 然后用于建库保存为`_proofread.ds`
# model = Proofreading("checkpoints/step1/align.ckpt")
# model.process("/gpfs/home/shangzengqiang/yangchen/SongEdit/data/insert",
#               "data/temp_insert")


# 例子：陈鸿宇-火烧云.ds
#
# 98 行插入新的字典，对103行的字典中的text 进行直接修改
""" 插入
    {
        "offset": 73,
        "offset_end": 74,
        "text": "一年"
    },
    ==>
    
    {
        "offset": 73,
        "text": "SP 一 年",
        "word_seq": "SP yi nian",
        "word2ph": "1 2 2",
        "word_dur": "0.107390 0.606700 0.285910",
        "ph_seq": "SP y i n ian",
        "ph_dur": "0.107390 0.142200 0.464500 0.078300 0.207610",
        "ph_num": "2 2 1",
        "note_seq": "A#3-12 G3-9 D#3-3",
        "note_dur": "0.249590 0.542800 0.207610",
        "note_slur": "0 0 0",
        "f0_seq": "",
        "f0_timestep": "0.011609977324263039",
        "offset_end": 74
    },

    修改文字
    
    1. 原始的ds
        {
        "offset": 80.21220882852293,
        "text": "SP AP SP AP SP 我 们 的 理 想 SP 早 已 实 现 SP AP 往 显 对 岸 的 SP 新 SP 世 界 SP 原 来 还 有 人 SP 继 续 冒 险 AP 长 期 的 采 观 SP 开 着 门 SP AP 热 播 大 结 局 SP 又 上 新 片 AP 避 免 心 里 一 朵",
        "word_seq": "SP AP SP AP SP wo men de li xiang SP zao yi shi xian SP AP wang xian dui an de SP xin SP shi jie SP yuan lai hai you ren SP ji xu mao xian AP chang qi de cai guan SP kai zhe men SP AP re bo da jie ju SP you shang xin pian AP bi mian xin li yi duo",
        "word2ph": "1 1 1 1 1 2 2 2 2 2 1 2 2 2 2 1 1 2 2 2 1 2 1 2 1 2 2 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 1 2 2 2 1 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 2",
        "word_dur": "1.509300 0.127710 0.731430 0.116100 0.519520 0.081290 0.232240 0.539870 0.217700 0.203020 1.283010 0.313410 0.188700 0.316340 0.188700 0.687900 0.348290 0.278660 0.316380 0.377360 0.002800 0.716940 0.815610 0.377330 0.206110 0.371530 0.551420 0.606580 0.075590 0.269840 0.444130 0.394650 1.114610 0.275730 0.304750 0.362820 0.008650 0.638590 0.667590 0.400550 0.246760 0.211930 0.618180 1.111600 0.333820 0.327940 0.293220 0.473070 0.365720 0.264110 0.319230 0.301910 0.264220 0.322140 0.470160 0.711120 0.467340 0.319180 0.348310 0.522470 0.656150 0.263940 0.200280 0.327940 0.423800 0.259480 0.627220",
        "ph_seq": "SP AP SP AP SP w o m en d e l i x iang SP z ao y i sh ir x ian SP AP w ang x ian d ui an d e SP x in SP sh ir j ie SP y van l ai h ai y ou r en SP j i x v m ao x ian AP ch ang q i d e c ai g uan SP k ai zh e m en SP AP r e b o d a j ie j v SP y ou sh ang x in p ian AP b i m ian x in l i y i d uo",
        "ph_dur": "1.509300 0.127710 0.731430 0.116100 0.519520 0.078180 0.003110 0.066770 0.165470 0.324900 0.214970 0.066650 0.151050 0.133460 0.069560 1.283010 0.130790 0.182620 0.174160 0.014540 0.182850 0.133490 0.185790 0.002910 0.687900 0.348290 0.072710 0.205950 0.127670 0.188710 0.075460 0.301900 0.002800 0.179970 0.536970 0.815610 0.174050 0.203280 0.206110 0.177140 0.194390 0.095740 0.455680 0.606580 0.017440 0.058150 0.014400 0.255440 0.319250 0.124880 0.174310 0.220340 0.095740 1.018870 0.275730 0.121910 0.182840 0.101530 0.261290 0.005840 0.002810 0.353920 0.284670 0.667590 0.133510 0.267040 0.104430 0.142330 0.075320 0.136610 0.185690 0.432490 0.139260 0.972340 0.333820 0.092730 0.235210 0.095770 0.197450 0.081200 0.391870 0.365720 0.264110 0.174170 0.145060 0.049340 0.252570 0.052260 0.211960 0.089830 0.232310 0.104480 0.365680 0.711120 0.348150 0.119190 0.127510 0.191670 0.130780 0.217530 0.101640 0.420830 0.656150 0.011310 0.252630 0.060920 0.139360 0.150820 0.177120 0.089980 0.333820 0.005790 0.253690 0.004670 0.622550",
        "ph_num": "1 1 1 1 2 2 2 2 2 1 2 2 2 2 1 1 2 2 2 1 2 1 2 1 2 2 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 1 2 2 2 1 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 2 1",
        "note_seq": "A#2-8 B2-44 G#2+6 rest rest rest A#2-7 G#2-5 G#2-22 G#2+18 G2+3 B2-15 A#2-32 G#2-1 F2-4 F2+3 rest C3-9 A#2+1 G#2-2 F#2-14 F2-3 rest A#2-2 C3-2 G#2-3 G#2-3 rest rest A#2+0 G#2+4 G#2-18 G2+27 F3+11 B2+10 A#2-3 G#2+8 F2-4 F2-10 A2-15 D#3-7 C3-18 D#3-4 F3+5 rest D3+0 D#3-3 C3-5 B2+12 G2-1 D#3-7 C#3-6 C3-11 A2+1 F#2+27 D#2-5 D#2+16 F2+3 G2+1 G#2+2 rest C3+4 D#3-7 C3+0 D#3+4 F3-4 F3-3",
        "note_dur": "1.509300 0.127710 0.731430 0.116100 0.597700 0.069880 0.490370 0.281620 0.284510 0.069560 1.413800 0.356780 0.197390 0.319280 0.002910 0.687900 0.421000 0.333620 0.264170 0.301900 0.182770 0.536970 0.989660 0.203280 0.383250 0.290130 0.455680 0.624020 0.072550 0.574690 0.299190 0.316080 1.018870 0.397640 0.284370 0.267130 0.356730 0.284670 0.801100 0.371470 0.217650 0.322300 0.571750 0.972340 0.426550 0.330980 0.278650 0.391870 0.365720 0.438280 0.194400 0.304830 0.301790 0.336790 0.365680 1.059270 0.246700 0.322450 0.319170 0.420830 0.667460 0.313550 0.290180 0.267100 0.339610 0.258360 0.622550",
        "note_slur": "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0",
        "f0_seq": "",
        "f0_timestep": "0.011609977324263039",
        "offset_end": 108.44620882852293
    },
    
    2. 修改原有文字
    
        {
        "offset": 80.21220882852293,
        # NOTE 
        "text": "在 这 三 十 平 的 房 间 我 们 的 理 想 SP 早 已 实 现 SP AP 往 显 对 岸 的 SP 新 SP 世 界 SP 原 来 还 有 人 SP 继 续 冒 险 AP 长 期 的 采 观 SP 开 着 门 SP AP 热 播 大 结 局 SP 又 上 新 片 AP 避 免 心 里 一 朵",
        
        "word_seq": "SP AP SP AP SP wo men de li xiang SP zao yi shi xian SP AP wang xian dui an de SP xin SP shi jie SP yuan lai hai you ren SP ji xu mao xian AP chang qi de cai guan SP kai zhe men SP AP re bo da jie ju SP you shang xin pian AP bi mian xin li yi duo",
        "word2ph": "1 1 1 1 1 2 2 2 2 2 1 2 2 2 2 1 1 2 2 2 1 2 1 2 1 2 2 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 1 2 2 2 1 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 2",
        "word_dur": "1.509300 0.127710 0.731430 0.116100 0.519520 0.081290 0.232240 0.539870 0.217700 0.203020 1.283010 0.313410 0.188700 0.316340 0.188700 0.687900 0.348290 0.278660 0.316380 0.377360 0.002800 0.716940 0.815610 0.377330 0.206110 0.371530 0.551420 0.606580 0.075590 0.269840 0.444130 0.394650 1.114610 0.275730 0.304750 0.362820 0.008650 0.638590 0.667590 0.400550 0.246760 0.211930 0.618180 1.111600 0.333820 0.327940 0.293220 0.473070 0.365720 0.264110 0.319230 0.301910 0.264220 0.322140 0.470160 0.711120 0.467340 0.319180 0.348310 0.522470 0.656150 0.263940 0.200280 0.327940 0.423800 0.259480 0.627220",
        "ph_seq": "SP AP SP AP SP w o m en d e l i x iang SP z ao y i sh ir x ian SP AP w ang x ian d ui an d e SP x in SP sh ir j ie SP y van l ai h ai y ou r en SP j i x v m ao x ian AP ch ang q i d e c ai g uan SP k ai zh e m en SP AP r e b o d a j ie j v SP y ou sh ang x in p ian AP b i m ian x in l i y i d uo",
        "ph_dur": "1.509300 0.127710 0.731430 0.116100 0.519520 0.078180 0.003110 0.066770 0.165470 0.324900 0.214970 0.066650 0.151050 0.133460 0.069560 1.283010 0.130790 0.182620 0.174160 0.014540 0.182850 0.133490 0.185790 0.002910 0.687900 0.348290 0.072710 0.205950 0.127670 0.188710 0.075460 0.301900 0.002800 0.179970 0.536970 0.815610 0.174050 0.203280 0.206110 0.177140 0.194390 0.095740 0.455680 0.606580 0.017440 0.058150 0.014400 0.255440 0.319250 0.124880 0.174310 0.220340 0.095740 1.018870 0.275730 0.121910 0.182840 0.101530 0.261290 0.005840 0.002810 0.353920 0.284670 0.667590 0.133510 0.267040 0.104430 0.142330 0.075320 0.136610 0.185690 0.432490 0.139260 0.972340 0.333820 0.092730 0.235210 0.095770 0.197450 0.081200 0.391870 0.365720 0.264110 0.174170 0.145060 0.049340 0.252570 0.052260 0.211960 0.089830 0.232310 0.104480 0.365680 0.711120 0.348150 0.119190 0.127510 0.191670 0.130780 0.217530 0.101640 0.420830 0.656150 0.011310 0.252630 0.060920 0.139360 0.150820 0.177120 0.089980 0.333820 0.005790 0.253690 0.004670 0.622550",
        "ph_num": "1 1 1 1 2 2 2 2 2 1 2 2 2 2 1 1 2 2 2 1 2 1 2 1 2 2 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 1 2 2 2 1 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 2 1",
        "note_seq": "A#2-8 B2-44 G#2+6 rest rest rest A#2-7 G#2-5 G#2-22 G#2+18 G2+3 B2-15 A#2-32 G#2-1 F2-4 F2+3 rest C3-9 A#2+1 G#2-2 F#2-14 F2-3 rest A#2-2 C3-2 G#2-3 G#2-3 rest rest A#2+0 G#2+4 G#2-18 G2+27 F3+11 B2+10 A#2-3 G#2+8 F2-4 F2-10 A2-15 D#3-7 C3-18 D#3-4 F3+5 rest D3+0 D#3-3 C3-5 B2+12 G2-1 D#3-7 C#3-6 C3-11 A2+1 F#2+27 D#2-5 D#2+16 F2+3 G2+1 G#2+2 rest C3+4 D#3-7 C3+0 D#3+4 F3-4 F3-3",
        "note_dur": "1.509300 0.127710 0.731430 0.116100 0.597700 0.069880 0.490370 0.281620 0.284510 0.069560 1.413800 0.356780 0.197390 0.319280 0.002910 0.687900 0.421000 0.333620 0.264170 0.301900 0.182770 0.536970 0.989660 0.203280 0.383250 0.290130 0.455680 0.624020 0.072550 0.574690 0.299190 0.316080 1.018870 0.397640 0.284370 0.267130 0.356730 0.284670 0.801100 0.371470 0.217650 0.322300 0.571750 0.972340 0.426550 0.330980 0.278650 0.391870 0.365720 0.438280 0.194400 0.304830 0.301790 0.336790 0.365680 1.059270 0.246700 0.322450 0.319170 0.420830 0.667460 0.313550 0.290180 0.267100 0.339610 0.258360 0.622550",
        "note_slur": "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0",
        "f0_seq": "",
        "f0_timestep": "0.011609977324263039",
        "offset_end": 108.44620882852293
    },
    
    3. 结果
    
    {
        "offset": 80.21220882852293,
        "text": "在 SP 这 三 十 平 的 房 间 SP AP SP 我 们 的 理 想 SP 早 已 实 现 SP AP 往 显 对 岸 的 SP 新 SP 世 界 SP 原 来 还 有 人 SP 继 续 冒 险 AP 长 期 的 采 观 SP 开 着 门 SP AP 热 播 大 结 局 SP 又 上 新 片 AP 避 免 心 里 一 朵",
        "word_seq": "zai SP zhe san shi ping de fang jian SP AP SP wo men de li xiang SP zao yi shi xian SP AP wang xian dui an de SP xin SP shi jie SP yuan lai hai you ren SP ji xu mao xian AP zhang qi de cai guan SP kai zhe men SP AP re bo da jie ju SP you shang xin pian AP bi mian xin li yi duo",
        "word2ph": "2 1 2 2 2 2 2 2 2 1 1 1 2 2 2 2 2 1 2 2 2 2 1 1 2 2 2 1 2 1 2 1 2 2 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 1 2 2 2 1 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 2",
        "word_dur": "0.005810 1.071010 0.269940 0.005800 0.005810 0.008710 0.104500 0.380080 0.110440 0.406340 0.116100 0.516650 0.330860 0.150930 0.374480 0.217700 0.203030 1.283000 0.313410 0.188700 0.316340 0.188700 0.687900 0.348290 0.278660 0.316380 0.377360 0.002800 0.716930 0.824320 0.368630 0.206110 0.374400 0.548550 0.606580 0.075590 0.269840 0.444130 0.394650 1.114610 0.275730 0.307600 0.359970 0.008650 0.647320 0.667580 0.394720 0.124820 0.330980 0.618180 1.111600 0.333820 0.327940 0.249640 0.548570 0.333800 0.264110 0.319230 0.301910 0.264220 0.322140 0.470160 0.711120 0.467340 0.319180 0.348310 0.522470 0.656150 0.261110 0.203110 0.327940 0.423800 0.259480 0.627220",
        "ph_seq": "z ai SP zh e s an sh ir p ing d e f ang j ian SP AP SP w o m en d e l i x iang SP z ao y i sh ir x ian SP AP w ang x ian d ui an d e SP x in SP sh ir j ie SP y van l ai h ai y ou r en SP j i x v m ao x ian AP zh ang q i d e c ai g uan SP k ai zh e m en SP AP r e b o d a j ie j v SP y ou sh ang x in p ian AP b i m ian x in l i y i d uo",
        "ph_dur": "0.002900 0.002910 1.071010 0.002820 0.267120 0.002900 0.002900 0.002900 0.002910 0.005800 0.002910 0.002900 0.101600 0.179950 0.200130 0.092870 0.017570 0.406340 0.116100 0.516650 0.156670 0.174190 0.005780 0.145150 0.159500 0.214980 0.066650 0.151050 0.156790 0.046240 1.283000 0.130790 0.182620 0.174160 0.014540 0.182850 0.133490 0.176950 0.011750 0.687900 0.348290 0.072700 0.205960 0.124730 0.191650 0.075460 0.301900 0.002800 0.206100 0.510830 0.824320 0.165350 0.203280 0.206110 0.177130 0.197270 0.092870 0.455680 0.606580 0.011680 0.063910 0.014400 0.255440 0.319250 0.124880 0.176750 0.217900 0.095740 1.018870 0.275730 0.121910 0.185690 0.098680 0.261290 0.005840 0.002810 0.353920 0.293400 0.667580 0.119050 0.275670 0.101540 0.023280 0.194400 0.136580 0.182740 0.435440 0.139260 0.972340 0.333820 0.092720 0.235220 0.095770 0.153870 0.124780 0.423790 0.333800 0.264110 0.174170 0.145060 0.049350 0.252560 0.057990 0.206230 0.089830 0.232310 0.104480 0.365680 0.711120 0.348150 0.119190 0.127510 0.191670 0.130780 0.217530 0.101640 0.420830 0.656150 0.011310 0.249800 0.063750 0.139360 0.150840 0.177100 0.089990 0.333810 0.005790 0.253690 0.004660 0.622560",
        "ph_num": "1 1 2 2 2 2 2 2 2 1 1 1 2 2 2 2 2 1 2 2 2 2 1 1 2 2 2 1 2 1 2 1 2 2 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 1 2 2 2 1 1 2 2 2 2 2 1 2 2 2 2 1 2 2 2 2 2 2 1",
        "note_seq": "F2+1 F2+1 F2+1 A#2-10 C3-12 C3+13 C3+39 B2-12 A#2-2 G#2-28 G#2+9 rest rest C3-20 A#2-5 G#2-5 G#2-15 G#2+21 G2+3 B2-15 A#2-32 G#2-1 F2-4 F2+3 rest C3-9 A#2+1 G#2-2 F#2-14 F2-3 rest A#2-2 C3-2 G#2-3 G#2-3 rest rest A#2+0 G#2+4 G#2-18 G2+27 F3+11 B2+10 A#2-3 G#2+8 F2-6 F2-7 A2-15 D#3-7 C3-18 D#3-4 F3+5 rest D3+0 D#3-3 C3-5 rest G2-1 D#3-7 C#3-6 C3-11 A2+1 F#2+27 D#2-5 D#2+16 F2+3 G2+1 G#2+2 rest C3+4 D#3-7 C3+0 D#3+4 F3-4 F3-3",
        "note_dur": "0.002900 0.002910 1.073830 0.270020 0.005800 0.008710 0.005810 0.281550 0.293000 0.017570 0.406340 0.116100 0.673320 0.179970 0.304650 0.281630 0.307840 0.046240 1.413790 0.356780 0.197390 0.310440 0.011750 0.687900 0.420990 0.330690 0.267110 0.301900 0.208900 0.510830 0.989670 0.203280 0.383240 0.290140 0.455680 0.618260 0.078310 0.574690 0.301630 0.313640 1.018870 0.397640 0.284370 0.267130 0.356730 0.293400 0.786630 0.377210 0.217680 0.319320 0.574700 0.972340 0.426540 0.330990 0.278650 0.423790 0.333800 0.438280 0.194410 0.310550 0.296060 0.336790 0.365680 1.059270 0.246700 0.322450 0.319170 0.420830 0.667460 0.313550 0.290200 0.267090 0.339600 0.258350 0.622560",
        "note_slur": "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0",
        "f0_seq": "",
        "f0_timestep": "0.011609977324263039",
        "offset_end": 108.44620882852293
    },
"""


# 单独接口
# Source Separation

# model = VocalSeparate(
#         separate_model_path= "checkpoints/step1/separate_model.pt",
# )
# model.process(
#         input_folder_path="data/input_data/陈鸿宇-火烧云_副歌.flac",
#         out_path="data/dataset"
# )


# # MFA 对齐
# model = SOFA("checkpoints/step1/align.ckpt")
# model.process(
#     "/gpfs/home/shangzengqiang/yangchen/SongEdit/data/song_lyrics",
#     "/gpfs/home/shangzengqiang/yangchen/SongEdit/data/song_lyrics/align_out"
# )


# # MFA 后处理 textgrid/csv文件转成 ds
# postprocess("/gpfs/home/shangzengqiang/yangchen/SongEdit/data/song_lyrics",
#             "/gpfs/home/shangzengqiang/yangchen/SongEdit/data/song_lyrics/align_out",
#             "/gpfs/home/shangzengqiang/yangchen/SongEdit/data/song_lyrics/dataset")
